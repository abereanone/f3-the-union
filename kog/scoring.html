<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KOG Score - Kings of the Gloom - 2026</title>
  <link rel="icon" href="crown.svg" type="image/svg+xml" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 440px;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .meta {
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .note {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
    }
    details {
      margin: 0.25rem 0;
    }
    summary {
      cursor: pointer;
      font-weight: 600;
    }
    .top-nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      margin-bottom: 1rem;
      font-weight: 600;
      background: #fff;
    }
    .top-nav a {
      color: #1f3b6d;
      text-decoration: none;
    }
    .top-nav a:hover,
    .top-nav a:focus {
      text-decoration: underline;
    }
    .team {
      border: 1px solid #ccc;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }
    .week {
      margin-left: 1rem;
    }
    .pax {
      margin-left: 2rem;
    }
    .events {
      margin-left: 3rem;
      font-size: 0.9rem;
    }
    .excluded {
      color: #999;
      text-decoration: line-through;
    }
    .score {
      float: right;
      font-weight: 700;
    }
    .clear {
      clear: both;
    }
  </style>
</head>
<body>

<div id="top-nav"></div>
<h1>KOG Score</h1>
<div class="note">
  Due to PAXMiner and <strong>Q</strong> delays, some beatdowns may be missing. The page refreshes nightly.
</div>
<div id="generated-at" class="meta"></div>

<div id="app">Loading…</div>

<script>
const dataBaseUrl = 'https://raw.githubusercontent.com/abereanone/f3-the-union/kog-data/data/';

async function loadJSON(path) {
  const res = await fetch(`${dataBaseUrl}${path}`);
  return res.json();
}

function normalizeDateString(dateStr) {
  if (!dateStr) return '';
  return dateStr.split('T')[0].split(' ')[0];
}

function formatGeneratedAt(value) {
  if (!value) return '';
  const [datePart, timePartRaw] = value.split('T');
  if (!timePartRaw) return datePart;
  const timePart = timePartRaw.split(/[+-]/)[0];
  const hm = timePart.split(':').slice(0, 2).join(':');
  return `${datePart} ${hm}`;
}

function parseYmd(dateStr) {
  const ymd = normalizeDateString(dateStr).split('-');
  if (ymd.length !== 3) return null;
  return {
    y: Number(ymd[0]),
    m: Number(ymd[1]),
    d: Number(ymd[2])
  };
}

function addDays(dateStr, days) {
  const parts = parseYmd(dateStr);
  if (!parts) return '';
  const t = Date.UTC(parts.y, parts.m - 1, parts.d + days);
  const d = new Date(t);
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth() + 1).padStart(2, '0');
  const day = String(d.getUTCDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function formatMonthDay(dateStr) {
  const parts = parseYmd(dateStr);
  if (!parts) return '';
  const m = String(parts.m).padStart(2, '0');
  const d = String(parts.d).padStart(2, '0');
  return `${m}-${d}`;
}

function formatScore(value) {
  if (value === null || value === undefined || value === '') return '';
  return `${value}%`;
}
function groupBy(arr, keyFn) {
  return arr.reduce((m, o) => {
    const k = keyFn(o);
    (m[k] ||= []).push(o);
    return m;
  }, {});
}

(async function init() {
  const [
    teamCumulative,
    teamWeekly,
    paxWeekly,
    meta,
    paxEvents
  ] = await Promise.all([
    loadJSON('team_cumulative.json'),
    loadJSON('team_weekly.json'),
    loadJSON('pax_weekly.json'),
    loadJSON('meta.json'),
    loadJSON('pax_events.json')
  ]);

  const generatedAt = document.getElementById('generated-at');
  if (generatedAt) {
    generatedAt.textContent = `Last Refreshed: ${formatGeneratedAt(meta?.generatedAt)}`;
  }

  // sort teams by cumulative DESC
  teamCumulative.sort((a,b) => b.AvgScore - a.AvgScore);

  const weeklyByTeam = groupBy(teamWeekly, r => r.Team);
  const paxByTeamWeek = groupBy(
    paxWeekly,
    r => `${r.Team}|${r.WeekStart}`
  );
  const eventsByPaxWeek = groupBy(
    paxEvents,
    r => `${r.Pax}|${r.WeekStart}`
  );

  const app = document.getElementById('app');
  app.innerHTML = '';

  teamCumulative.forEach(teamRow => {
    const team = teamRow.Team;
    const teamScore = teamRow.AvgScore;

    const teamDetails = document.createElement('details');
    teamDetails.className = 'team';

    const teamSummary = document.createElement('summary');
    teamSummary.innerHTML = `${team} <span class="score">${formatScore(teamScore)}</span>`;
    teamDetails.appendChild(teamSummary);

    (weeklyByTeam[team] || [])
      .sort((a,b) => a.WeekStart.localeCompare(b.WeekStart))
      .forEach(weekRow => {
        const weekKey = `${team}|${weekRow.WeekStart}`;
        const weekDetails = document.createElement('details');
        weekDetails.className = 'week';

        const weekSummary = document.createElement('summary');
        const weekEnd = addDays(weekRow.WeekStart, 6);
        weekSummary.innerHTML =
          `Week of ${formatMonthDay(weekRow.WeekStart)} - ${formatMonthDay(weekEnd)} <span class="score">${formatScore(weekRow.AvgScore)}</span>`;
        weekDetails.appendChild(weekSummary);

        (paxByTeamWeek[weekKey] || [])
          .sort((a,b) => b.Score - a.Score)
          .forEach(paxRow => {
            const paxDetails = document.createElement('details');
            paxDetails.className = 'pax';

            const paxSummary = document.createElement('summary');
            paxSummary.innerHTML =
              `${paxRow.Pax} <span class="score">${formatScore(paxRow.Score)}</span>`;
            paxDetails.appendChild(paxSummary);

            const evKey = `${paxRow.Pax}|${weekRow.WeekStart}`;
            const evList = document.createElement('div');
            evList.className = 'events';

            (eventsByPaxWeek[evKey] || [])
              .sort((a,b) => new Date(a.Date) - new Date(b.Date))
              .forEach(ev => {
                const line = document.createElement('div');
                line.textContent =
                  `${formatMonthDay(ev.Date)} — ${ev.AO}` +
                  (ev.Counted ? '' : ` (${ev.Reason})`);
                if (!ev.Counted) line.className = 'excluded';
                evList.appendChild(line);
              });

            paxDetails.appendChild(evList);
            weekDetails.appendChild(paxDetails);
          });

        teamDetails.appendChild(weekDetails);
      });

    app.appendChild(teamDetails);
  });
})();
</script>
<script src="/shared/top-nav.js"></script>

</body>
</html>
